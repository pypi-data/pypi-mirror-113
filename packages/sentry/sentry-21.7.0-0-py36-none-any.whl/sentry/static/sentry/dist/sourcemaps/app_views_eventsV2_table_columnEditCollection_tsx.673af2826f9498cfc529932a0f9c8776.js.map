{"version":3,"sources":["webpack:///./app/utils/userselect.tsx","webpack:///./app/utils/touch.tsx","webpack:///./app/views/eventsV2/table/columnEditCollection.tsx"],"names":["setBodyUserSelect","nextValues","previousValues","userSelect","document","body","style","MozUserSelect","msUserSelect","webkitUserSelect","getPointerPosition","event","property","actual","nativeEvent","window","TouchEvent","targetTouches","MouseEvent","PlaceholderPosition","DRAG_CLASS","ColumnEditCollection","isDragging","draggingIndex","draggingTargetIndex","draggingGrabbedOffset","left","top","React","props","onChange","columns","kind","field","organization","newColumn","FieldValueKind","trackAnalyticsEvent","eventKey","eventName","organization_id","parseInt","id","index","column","newColumns","splice","state","includes","type","preventDefault","stopPropagation","pointerX","pointerY","dragOffsetX","x","dragOffsetY","y","dragGhostRef","current","ghostDOM","dragItems","querySelectorAll","targetIndex","Array","from","findIndex","dragItem","rects","getBoundingClientRect","thresholdStart","scrollY","thresholdEnd","height","setState","sourceIndex","cleanUpListeners","previousUserSelect","removed","undefined","this","portal","createElement","position","zIndex","String","theme","appendChild","removeChild","isGhost","function","join","removeEventListener","onDragMove","onDragEnd","find","n","contains","currentTarget","addEventListener","gridColumns","Number","col","ghost","Ghost","ref","renderItem","ReactDOM","i","canDelete","fieldOptions","placeholder","DragPlaceholder","className","keyForColumn","TOP","BOTTOM","RowContainer","t","onMouseDown","startDrag","onTouchStart","icon","size","borderless","fieldValue","value","handleUpdateColumn","takeFocus","length","otherColumns","onClick","removeColumn","canAdd","title","Math","max","map","AGGREGATIONS","parameters","renderGhost","Heading","StyledSectionHeading","Actions","label","handleAddColumn","disabled","isCircled","features","handleAddEquation","StyledFeatureBadge","FeatureBadge","space","p","background","borderRadius","border","SectionHeading"],"mappings":"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","file":"chunks/app_views_eventsV2_table_columnEditCollection_tsx.xxxxxxxxxxxxxxxxxxxx.js","sourcesContent":["export type UserSelectValues = {\n  userSelect: string | null;\n  MozUserSelect: string | null;\n  msUserSelect: string | null;\n  webkitUserSelect: string | null;\n};\n\nexport const setBodyUserSelect = (nextValues: UserSelectValues): UserSelectValues => {\n  // NOTE: Vendor prefixes other than `ms` should begin with a capital letter.\n  // ref: https://reactjs.org/docs/dom-elements.html#style\n\n  const previousValues = {\n    userSelect: document.body.style.userSelect,\n    // MozUserSelect is not typed in TS\n    // @ts-expect-error\n    MozUserSelect: document.body.style.MozUserSelect,\n    // msUserSelect is not typed in TS\n    // @ts-expect-error\n    msUserSelect: document.body.style.msUserSelect,\n    webkitUserSelect: document.body.style.webkitUserSelect,\n  };\n\n  document.body.style.userSelect = nextValues.userSelect || '';\n  // MozUserSelect is not typed in TS\n  // @ts-expect-error\n  document.body.style.MozUserSelect = nextValues.MozUserSelect || '';\n  // msUserSelect is not typed in TS\n  // @ts-expect-error\n  document.body.style.msUserSelect = nextValues.msUserSelect || '';\n  document.body.style.webkitUserSelect = nextValues.webkitUserSelect || '';\n\n  return previousValues;\n};\n","function isReactEvent(\n  maybe: MouseEvent | TouchEvent | React.MouseEvent | React.TouchEvent\n): maybe is React.MouseEvent | React.TouchEvent {\n  return 'nativeEvent' in maybe;\n}\n\n/**\n * Handle getting position out of both React and Raw DOM events\n * as both are handled here due to mousedown/mousemove events\n * working differently.\n */\nexport function getPointerPosition(\n  event: MouseEvent | TouchEvent | React.MouseEvent | React.TouchEvent,\n  property: 'pageX' | 'pageY' | 'clientX' | 'clientY'\n): number {\n  const actual = isReactEvent(event) ? event.nativeEvent : event;\n  if (window.TouchEvent && actual instanceof TouchEvent) {\n    return actual.targetTouches[0][property];\n  }\n  if (actual instanceof MouseEvent) {\n    return actual[property];\n  }\n  return 0;\n}\n","import * as React from 'react';\nimport ReactDOM from 'react-dom';\nimport styled from '@emotion/styled';\n\nimport Feature from 'app/components/acl/feature';\nimport Button from 'app/components/button';\nimport {SectionHeading} from 'app/components/charts/styles';\nimport FeatureBadge from 'app/components/featureBadge';\nimport {IconAdd, IconDelete, IconGrabbable} from 'app/icons';\nimport {t} from 'app/locale';\nimport space from 'app/styles/space';\nimport {LightWeightOrganization} from 'app/types';\nimport {trackAnalyticsEvent} from 'app/utils/analytics';\nimport {AGGREGATIONS, Column} from 'app/utils/discover/fields';\nimport theme from 'app/utils/theme';\nimport {getPointerPosition} from 'app/utils/touch';\nimport {setBodyUserSelect, UserSelectValues} from 'app/utils/userselect';\n\nimport {generateFieldOptions} from '../utils';\n\nimport {QueryField} from './queryField';\nimport {FieldValueKind} from './types';\n\ntype Props = {\n  // Input columns\n  columns: Column[];\n  fieldOptions: ReturnType<typeof generateFieldOptions>;\n  // Fired when columns are added/removed/modified\n  onChange: (columns: Column[]) => void;\n  organization: LightWeightOrganization;\n  className?: string;\n};\n\ntype State = {\n  isDragging: boolean;\n  draggingIndex: undefined | number;\n  draggingTargetIndex: undefined | number;\n  draggingGrabbedOffset: undefined | {x: number; y: number};\n  left: undefined | number;\n  top: undefined | number;\n};\n\nconst DRAG_CLASS = 'draggable-item';\nconst GHOST_PADDING = 4;\nconst MAX_COL_COUNT = 20;\n\nenum PlaceholderPosition {\n  TOP,\n  BOTTOM,\n}\n\nclass ColumnEditCollection extends React.Component<Props, State> {\n  state: State = {\n    isDragging: false,\n    draggingIndex: void 0,\n    draggingTargetIndex: void 0,\n    draggingGrabbedOffset: void 0,\n    left: void 0,\n    top: void 0,\n  };\n\n  componentDidMount() {\n    if (!this.portal) {\n      const portal = document.createElement('div');\n\n      portal.style.position = 'absolute';\n      portal.style.top = '0';\n      portal.style.left = '0';\n      portal.style.zIndex = String(theme.zIndex.modal);\n\n      this.portal = portal;\n\n      document.body.appendChild(this.portal);\n    }\n  }\n\n  componentWillUnmount() {\n    if (this.portal) {\n      document.body.removeChild(this.portal);\n    }\n    this.cleanUpListeners();\n  }\n\n  previousUserSelect: UserSelectValues | null = null;\n  portal: HTMLElement | null = null;\n  dragGhostRef = React.createRef<HTMLDivElement>();\n\n  keyForColumn(column: Column, isGhost: boolean): string {\n    if (column.kind === 'function') {\n      return [...column.function, isGhost].join(':');\n    }\n    return [...column.field, isGhost].join(':');\n  }\n\n  cleanUpListeners() {\n    if (this.state.isDragging) {\n      window.removeEventListener('mousemove', this.onDragMove);\n      window.removeEventListener('touchmove', this.onDragMove);\n      window.removeEventListener('mouseup', this.onDragEnd);\n      window.removeEventListener('touchend', this.onDragEnd);\n    }\n  }\n\n  // Signal to the parent that a new column has been added.\n  handleAddColumn = () => {\n    const newColumn: Column = {kind: 'field', field: ''};\n    this.props.onChange([...this.props.columns, newColumn]);\n  };\n\n  handleAddEquation = () => {\n    const {organization} = this.props;\n    const newColumn: Column = {kind: FieldValueKind.EQUATION, field: ''};\n    trackAnalyticsEvent({\n      eventKey: 'discover_v2.add_equation',\n      eventName: 'Discoverv2: Equation added',\n      organization_id: parseInt(organization.id, 10),\n    });\n    this.props.onChange([...this.props.columns, newColumn]);\n  };\n\n  handleUpdateColumn = (index: number, column: Column) => {\n    const newColumns = [...this.props.columns];\n    newColumns.splice(index, 1, column);\n    this.props.onChange(newColumns);\n  };\n\n  removeColumn(index: number) {\n    const newColumns = [...this.props.columns];\n    newColumns.splice(index, 1);\n    this.props.onChange(newColumns);\n  }\n\n  startDrag(\n    event: React.MouseEvent<HTMLButtonElement> | React.TouchEvent<HTMLButtonElement>,\n    index: number\n  ) {\n    const isDragging = this.state.isDragging;\n    if (isDragging || !['mousedown', 'touchstart'].includes(event.type)) {\n      return;\n    }\n    event.preventDefault();\n    event.stopPropagation();\n\n    const top = getPointerPosition(event, 'pageY');\n    const left = getPointerPosition(event, 'pageX');\n\n    // Compute where the user clicked on the drag handle. Avoids the element\n    // jumping from the cursor on mousedown.\n    const {x, y} = Array.from(document.querySelectorAll(`.${DRAG_CLASS}`))\n      .find(n => n.contains(event.currentTarget))!\n      .getBoundingClientRect();\n\n    const draggingGrabbedOffset = {\n      x: left - x + GHOST_PADDING,\n      y: top - y + GHOST_PADDING,\n    };\n\n    // prevent the user from selecting things when dragging a column.\n    this.previousUserSelect = setBodyUserSelect({\n      userSelect: 'none',\n      MozUserSelect: 'none',\n      msUserSelect: 'none',\n      webkitUserSelect: 'none',\n    });\n\n    // attach event listeners so that the mouse cursor can drag anywhere\n    window.addEventListener('mousemove', this.onDragMove);\n    window.addEventListener('touchmove', this.onDragMove);\n    window.addEventListener('mouseup', this.onDragEnd);\n    window.addEventListener('touchend', this.onDragEnd);\n\n    this.setState({\n      isDragging: true,\n      draggingIndex: index,\n      draggingTargetIndex: index,\n      draggingGrabbedOffset,\n      top,\n      left,\n    });\n  }\n\n  onDragMove = (event: MouseEvent | TouchEvent) => {\n    const {isDragging, draggingTargetIndex, draggingGrabbedOffset} = this.state;\n\n    if (!isDragging || !['mousemove', 'touchmove'].includes(event.type)) {\n      return;\n    }\n    event.preventDefault();\n    event.stopPropagation();\n\n    const pointerX = getPointerPosition(event, 'pageX');\n    const pointerY = getPointerPosition(event, 'pageY');\n\n    const dragOffsetX = draggingGrabbedOffset?.x ?? 0;\n    const dragOffsetY = draggingGrabbedOffset?.y ?? 0;\n\n    if (this.dragGhostRef.current) {\n      // move the ghost box\n      const ghostDOM = this.dragGhostRef.current;\n      // Adjust so cursor is over the grab handle.\n      ghostDOM.style.left = `${pointerX - dragOffsetX}px`;\n      ghostDOM.style.top = `${pointerY - dragOffsetY}px`;\n    }\n\n    const dragItems = document.querySelectorAll(`.${DRAG_CLASS}`);\n    // Find the item that the ghost is currently over.\n    const targetIndex = Array.from(dragItems).findIndex(dragItem => {\n      const rects = dragItem.getBoundingClientRect();\n      const top = pointerY;\n\n      const thresholdStart = window.scrollY + rects.top;\n      const thresholdEnd = window.scrollY + rects.top + rects.height;\n\n      return top >= thresholdStart && top <= thresholdEnd;\n    });\n\n    if (targetIndex >= 0 && targetIndex !== draggingTargetIndex) {\n      this.setState({draggingTargetIndex: targetIndex});\n    }\n  };\n\n  onDragEnd = (event: MouseEvent | TouchEvent) => {\n    if (!this.state.isDragging || !['mouseup', 'touchend'].includes(event.type)) {\n      return;\n    }\n\n    const sourceIndex = this.state.draggingIndex;\n    const targetIndex = this.state.draggingTargetIndex;\n    if (typeof sourceIndex !== 'number' || typeof targetIndex !== 'number') {\n      return;\n    }\n\n    // remove listeners that were attached in startColumnDrag\n    this.cleanUpListeners();\n\n    // restore body user-select values\n    if (this.previousUserSelect) {\n      setBodyUserSelect(this.previousUserSelect);\n      this.previousUserSelect = null;\n    }\n\n    // Reorder columns and trigger change.\n    const newColumns = [...this.props.columns];\n    const removed = newColumns.splice(sourceIndex, 1);\n    newColumns.splice(targetIndex, 0, removed[0]);\n    this.props.onChange(newColumns);\n\n    this.setState({\n      isDragging: false,\n      left: undefined,\n      top: undefined,\n      draggingIndex: undefined,\n      draggingTargetIndex: undefined,\n      draggingGrabbedOffset: undefined,\n    });\n  };\n\n  renderGhost(gridColumns: number) {\n    const {isDragging, draggingIndex, draggingGrabbedOffset} = this.state;\n\n    const index = draggingIndex;\n    if (typeof index !== 'number' || !isDragging || !this.portal) {\n      return null;\n    }\n    const dragOffsetX = draggingGrabbedOffset?.x ?? 0;\n    const dragOffsetY = draggingGrabbedOffset?.y ?? 0;\n\n    const top = Number(this.state.top) - dragOffsetY;\n    const left = Number(this.state.left) - dragOffsetX;\n    const col = this.props.columns[index];\n\n    const style = {\n      top: `${top}px`,\n      left: `${left}px`,\n    };\n    const ghost = (\n      <Ghost ref={this.dragGhostRef} style={style}>\n        {this.renderItem(col, index, {isGhost: true, gridColumns})}\n      </Ghost>\n    );\n\n    return ReactDOM.createPortal(ghost, this.portal);\n  }\n\n  renderItem(\n    col: Column,\n    i: number,\n    {\n      canDelete = true,\n      isGhost = false,\n      gridColumns = 2,\n    }: {canDelete?: boolean; isGhost?: boolean; gridColumns: number}\n  ) {\n    const {columns, fieldOptions} = this.props;\n    const {isDragging, draggingTargetIndex, draggingIndex} = this.state;\n\n    let placeholder: React.ReactNode = null;\n    // Add a placeholder above the target row.\n    if (isDragging && isGhost === false && draggingTargetIndex === i) {\n      placeholder = (\n        <DragPlaceholder\n          key={`placeholder:${this.keyForColumn(col, isGhost)}`}\n          className={DRAG_CLASS}\n        />\n      );\n    }\n\n    // If the current row is the row in the drag ghost return the placeholder\n    // or a hole if the placeholder is elsewhere.\n    if (isDragging && isGhost === false && draggingIndex === i) {\n      return placeholder;\n    }\n\n    const position =\n      Number(draggingTargetIndex) <= Number(draggingIndex)\n        ? PlaceholderPosition.TOP\n        : PlaceholderPosition.BOTTOM;\n\n    return (\n      <React.Fragment key={`${i}:${this.keyForColumn(col, isGhost)}`}>\n        {position === PlaceholderPosition.TOP && placeholder}\n        <RowContainer className={isGhost ? '' : DRAG_CLASS}>\n          {canDelete ? (\n            <Button\n              aria-label={t('Drag to reorder')}\n              onMouseDown={event => this.startDrag(event, i)}\n              onTouchStart={event => this.startDrag(event, i)}\n              icon={<IconGrabbable size=\"xs\" />}\n              size=\"zero\"\n              borderless\n            />\n          ) : (\n            <span />\n          )}\n          <QueryField\n            fieldOptions={fieldOptions}\n            gridColumns={gridColumns}\n            fieldValue={col}\n            onChange={value => this.handleUpdateColumn(i, value)}\n            takeFocus={i === this.props.columns.length - 1}\n            otherColumns={columns}\n          />\n          {canDelete ? (\n            <Button\n              aria-label={t('Remove column')}\n              onClick={() => this.removeColumn(i)}\n              icon={<IconDelete />}\n              borderless\n            />\n          ) : (\n            <span />\n          )}\n        </RowContainer>\n        {position === PlaceholderPosition.BOTTOM && placeholder}\n      </React.Fragment>\n    );\n  }\n\n  render() {\n    const {className, columns, organization} = this.props;\n    const canDelete = columns.length > 1;\n    const canAdd = columns.length < MAX_COL_COUNT;\n    const title = canAdd\n      ? undefined\n      : `Sorry, you reached the maximum number of columns. Delete columns to add more.`;\n\n    // Get the longest number of columns so we can layout the rows.\n    // We always want at least 2 columns.\n    const gridColumns = Math.max(\n      ...columns.map(col =>\n        col.kind === 'function' && AGGREGATIONS[col.function[0]].parameters.length === 2\n          ? 3\n          : 2\n      )\n    );\n\n    return (\n      <div className={className}>\n        {this.renderGhost(gridColumns)}\n        <RowContainer>\n          <Heading gridColumns={gridColumns}>\n            <StyledSectionHeading>{t('Tag / Field / Function')}</StyledSectionHeading>\n            <StyledSectionHeading>{t('Field Parameter')}</StyledSectionHeading>\n          </Heading>\n        </RowContainer>\n        {columns.map((col: Column, i: number) =>\n          this.renderItem(col, i, {canDelete, gridColumns})\n        )}\n        <RowContainer>\n          <Actions>\n            <Button\n              size=\"small\"\n              label={t('Add a Column')}\n              onClick={this.handleAddColumn}\n              title={title}\n              disabled={!canAdd}\n              icon={<IconAdd isCircled size=\"xs\" />}\n            >\n              {t('Add a Column')}\n            </Button>\n            <Feature organization={organization} features={['discover-arithmetic']}>\n              <Button\n                size=\"small\"\n                label={t('Add an Equation')}\n                onClick={this.handleAddEquation}\n                title={title}\n                disabled={!canAdd}\n                icon={<IconAdd isCircled size=\"xs\" />}\n              >\n                {t('Add an Equation')}\n                <StyledFeatureBadge type=\"beta\" />\n              </Button>\n            </Feature>\n          </Actions>\n        </RowContainer>\n      </div>\n    );\n  }\n}\n\nconst StyledFeatureBadge = styled(FeatureBadge)`\n  margin: -${space(0.5)} auto;\n  margin-left: ${space(1)};\n`;\n\nconst RowContainer = styled('div')`\n  display: grid;\n  grid-template-columns: ${space(3)} 1fr ${space(3)};\n  justify-content: center;\n  align-items: center;\n  width: 100%;\n  touch-action: none;\n  padding-bottom: ${space(1)};\n`;\n\nconst Ghost = styled('div')`\n  background: ${p => p.theme.background};\n  display: block;\n  position: absolute;\n  padding: ${GHOST_PADDING}px;\n  border-radius: ${p => p.theme.borderRadius};\n  box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);\n  width: 710px;\n  opacity: 0.8;\n  cursor: grabbing;\n  padding-right: ${space(2)};\n\n  & > ${RowContainer} {\n    padding-bottom: 0;\n  }\n\n  & svg {\n    cursor: grabbing;\n  }\n`;\n\nconst DragPlaceholder = styled('div')`\n  margin: 0 ${space(3)} ${space(1)} ${space(3)};\n  border: 2px dashed ${p => p.theme.border};\n  border-radius: ${p => p.theme.borderRadius};\n  height: 41px;\n`;\n\nconst Actions = styled('div')`\n  grid-column: 2 / 3;\n\n  & button {\n    margin-right: ${space(1)};\n  }\n`;\n\nconst Heading = styled('div')<{gridColumns: number}>`\n  grid-column: 2 / 3;\n\n  /* Emulate the grid used in the column editor rows */\n  display: grid;\n  grid-template-columns: repeat(${p => p.gridColumns}, 1fr);\n  grid-column-gap: ${space(1)};\n`;\n\nconst StyledSectionHeading = styled(SectionHeading)`\n  margin: 0;\n`;\n\nexport default ColumnEditCollection;\n"],"sourceRoot":""}