{"version":3,"sources":["script-editor.js","index.js"],"names":["Messages","window","settings","names","infos","controller","optionLists","showSuccessAndError","data","error","enqueue","text","_","isString","gettext","tags","success","apiRequest","command","options","request","extend","req","m","method","url","apiUrl","config","xhr","setRequestHeader","ShuupAdminConfig","csrf","then","response","Controller","ctrl","steps","prop","currentItem","newStepItemModalInfo","removeStepItem","step","itemType","item","listName","reject","i","activateStepItem","addStepItem","identifier","activateForEdit","push","setStepItemEditorState","state","document","getElementById","style","display","src","frm","createElement","target","action","itemEditorUrl","appendChild","name","type","value","JSON","stringify","eventIdentifier","body","submit","receiveItemEditData","alert","startComputation","endComputation","saveState","deleteStep","s","addNewStep","actions","conditions","enabled","next","condOp","moveStep","delta","oldIndex","indexOf","newIndex","splice","promptForNewStepItem","title","closeNewStepItemModal","createNewStepItemFromModal","info","workflowItemList","nameMap","items","list","map","tag","current","href","onclick","partial","confirm","stepTableRows","index","condOpSelect","cond_op","onchange","withAttr","condOps","stepNextSelect","stepNexts","className","key","id","length","renderNewStepItemModal","modalInfo","sortBy","values","description","view","modal","generateItemOptions","o","children","toLowerCase","itemInfosToNameMap","itemInfos","Object","assign","keys","init","iSettings","condition","conditionInfos","actionInfos","mount","addEventListener","event","new_data","save","ScriptEditor","hideEditModal"],"mappings":"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","file":"script-editor.js","sourceRoot":"../../../static_src","sourcesContent":["/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n// IMPORTANT: This script assumes that lodash and mithriljs@0.2.0\n// are available in global scope, installed from Shuup Admin static source\nconst Messages = window.Messages;\n\nvar settings = {};\nconst names = {};\nconst infos = {};\nvar controller = null;\nconst optionLists = {};\n\nfunction showSuccessAndError(data) {\n    if (data.error) {\n        Messages.enqueue({\n            text: _.isString(data.error) ? data.error : gettext(\"Error!\"),\n            tags: \"error\"\n        });\n    }\n    if (data.success) {\n        Messages.enqueue({\n            text: _.isString(data.success) ? data.success : gettext(\"Success!\"),\n            tags: \"success\"\n        });\n    }\n}\n\nfunction apiRequest(command, data, options) {\n    const request = _.extend({}, {\"command\": command}, data || {});\n    const req = m.request(_.extend({\n        method: \"POST\",\n        url: settings.apiUrl,\n        data: request,\n        config: function(xhr) {\n            xhr.setRequestHeader(\"X-CSRFToken\", window.ShuupAdminConfig.csrf);\n        }\n    }, options));\n    req.then(function(response) {\n        showSuccessAndError(response);\n    }, function() {\n        Messages.enqueue({text: gettext(\"Error! An unspecified error occurred.\"), tags: \"error\"});\n    });\n    return req;\n}\n\nfunction Controller() {\n    const ctrl = this;\n    ctrl.steps = m.prop([]);\n    ctrl.currentItem = m.prop(null);\n    ctrl.newStepItemModalInfo = m.prop(null);\n\n    apiRequest(\"getData\").then(function(data) {\n        ctrl.steps(data.steps);\n    });\n\n    ctrl.removeStepItem = function(step, itemType, item) {\n        const listName = itemType + \"s\";\n        step[listName] = _.reject(step[listName], function(i) {\n            return i === item;\n        });\n        if (ctrl.currentItem() === item) {\n            ctrl.activateStepItem(null, null, null);\n        }\n    };\n\n    ctrl.addStepItem = function(step, itemType, identifier, activateForEdit) {\n        const item = {\"identifier\": identifier};\n        const listName = itemType + \"s\";\n        step[listName].push(item);\n        if (activateForEdit) {\n            ctrl.activateStepItem(step, itemType, item);\n        }\n    };\n    ctrl.setStepItemEditorState = function(state) {\n        if (state) {\n            document.getElementById(\"step-item-wrapper\").style.display = \"flex\";\n        } else {\n            document.getElementById(\"step-item-wrapper\").style.display = \"none\";\n            document.getElementById(\"step-item-frame\").src = \"about:blank\";\n        }\n    };\n    ctrl.activateStepItem = function(step, itemType, item) {\n        if (step && item) {\n            ctrl.currentItem(item);\n            const frm = _.extend(document.createElement(\"form\"), {\n                target: \"step-item-frame\",\n                method: \"POST\",\n                action: settings.itemEditorUrl\n            });\n            frm.appendChild(_.extend(document.createElement(\"input\"), {\n                name: \"init_data\",\n                type: \"hidden\",\n                value: JSON.stringify({\n                    eventIdentifier: settings.eventIdentifier,\n                    itemType: itemType,\n                    data: item\n                })\n            }));\n            document.body.appendChild(frm);\n            frm.submit();\n            ctrl.setStepItemEditorState(true);\n        } else {\n            ctrl.currentItem(null);\n            ctrl.setStepItemEditorState(false);\n        }\n    };\n    ctrl.receiveItemEditData = function(data) {\n        const currentItem = ctrl.currentItem();\n        if (!currentItem) {\n            alert(gettext(\"Warning! Unexpected edit data was received.\"));\n            return;\n        }\n        m.startComputation();\n        ctrl.currentItem(_.extend(currentItem, data));\n        m.endComputation();\n    };\n    ctrl.saveState = function() {\n        apiRequest(\"saveData\", {\n            steps: ctrl.steps()\n        });\n\n        // TODO: Handle errors here?\n    };\n    ctrl.deleteStep = function(step) {\n        ctrl.steps(_.reject(ctrl.steps(), function(s) {\n            return s === step;\n        }));\n    };\n    ctrl.addNewStep = function() {\n        const step = {\n            actions: [],\n            conditions: [],\n            enabled: true,\n            next: \"continue\",\n            condOp: \"and\"\n        };\n        const steps = ctrl.steps();\n        steps.push(step);\n        ctrl.steps(steps);\n    };\n    ctrl.moveStep = function(step, delta) {\n        const steps = ctrl.steps();\n        const oldIndex = _.indexOf(steps, step);\n        if (oldIndex === -1) {\n            return false;\n        }\n        const newIndex = oldIndex + delta;\n        steps.splice(newIndex, 0, steps.splice(oldIndex, 1)[0]);\n        ctrl.steps(steps);\n    };\n    ctrl.promptForNewStepItem = function(step, itemType) {\n        ctrl.newStepItemModalInfo({\n            step: step,\n            itemType: itemType,\n            title: gettext(\"Add new\") + \" \" + itemType\n        });\n    };\n    ctrl.closeNewStepItemModal = function() {\n        ctrl.newStepItemModalInfo(null);\n    };\n    ctrl.createNewStepItemFromModal = function(identifier) {\n        const info = ctrl.newStepItemModalInfo();\n        ctrl.closeNewStepItemModal();\n        if (info === null) {\n            return;\n        }\n        ctrl.addStepItem(info.step, info.itemType, identifier, true);\n    };\n}\n\nfunction workflowItemList(ctrl, step, itemType) {\n    const listName = itemType + \"s\";\n    const nameMap = names[itemType];\n    const items = step[listName];\n    const list = m(\"ul.action-list\", items.map(function(item) {\n        const name = nameMap[item.identifier] || item.identifier;\n        var tag = \"li\";\n        const current = (ctrl.currentItem() === item);\n        if (current) {\n            tag += \".current\";\n        }\n        return m(tag,\n            [\n                m(\"a\", {\n                    href: \"#\",\n                    onclick: (!current ? _.partial(ctrl.activateStepItem, step, itemType, item) : null)\n                }, name),\n                \" \",\n                m(\"a.delete\", {\n                    href: \"#\", onclick: function() {\n                        if (!confirm(gettext(\"Delete this item?\\nThis is final and can't be undone.\"))) {\n                            return;\n                        }\n                        ctrl.removeStepItem(step, itemType, item);\n                    }\n                }, m(\"i.fa.fa-trash\"))\n            ]\n        );\n    }));\n    return m(\"div\", [\n        list,\n        m(\"div.action-new\", [m(\"a.btn.btn-xs.btn-primary\", {\n            href: \"#\",\n            onclick: _.partial(ctrl.promptForNewStepItem, step, itemType)\n        }, m(\"i.fa.fa-plus\"), \" \" + gettext(\"New\") + \" \" + itemType)])\n    ]);\n}\n\nfunction stepTableRows(ctrl) {\n    return _.map(ctrl.steps(), function(step, index) {\n        const condOpSelect = m(\"select\", {\n            value: step.cond_op,\n            onchange: m.withAttr(\"value\", function(value) {\n                step.cond_op = value;  // eslint-disable-line camelcase\n            })\n        }, optionLists.condOps);\n        const stepNextSelect = m(\"select\", {\n            value: step.next,\n            onchange: m.withAttr(\"value\", function(value) {\n                step.next = value;\n            })\n        }, optionLists.stepNexts);\n\n        return m(\"div\", {\n            className: \"step\" + (step.enabled ? \"\" : \" disabled\"),\n            key: step.id\n        }, [\n            m(\"div.step-buttons\", [\n                (index > 0 ? m(\"a\", {\n                    href: \"#\",\n                    title: gettext(\"Move Up\"),\n                    onclick: _.partial(ctrl.moveStep, step, -1)\n                }, m(\"i.fa.fa-caret-up\")) : null),\n                (index < ctrl.steps().length - 1 ? m(\"a\", {\n                    href: \"#\",\n                    title: gettext(\"Move Down\"),\n                    onclick: _.partial(ctrl.moveStep, step, +1)\n                }, m(\"i.fa.fa-caret-down\")) : null),\n                (step.enabled ?\n                    m(\"a\", {\n                        href: \"#\", title: gettext(\"Disable\"), onclick: function() {\n                            step.enabled = false;\n                        }\n                    }, m(\"i.fa.fa-ban\")) :\n                    m(\"a\", {\n                        href: \"#\", title: gettext(\"Enable\"), onclick: function() {\n                            step.enabled = true;\n                        }\n                    }, m(\"i.fa.fa-check-circle\"))\n                ),\n                m(\"a\", {\n                    href: \"#\", title: gettext(\"Delete\"), onclick: function() {\n                        if (confirm(gettext(\"Are you sure you want to delete this step?\"))) {\n                            ctrl.deleteStep(step);\n                        }\n                    }\n                }, m(\"i.fa.fa-trash\"))\n            ]),\n            m(\"div.step-conds\", [\n                m(\"span.hint\", gettext(\"If\"), condOpSelect, gettext(\"of these conditions hold...\")),\n                workflowItemList(ctrl, step, \"condition\")\n            ]),\n            m(\"div.step-actions\", [\n                m(\"span.hint\", gettext(\"then execute these actions...\")),\n                workflowItemList(ctrl, step, \"action\")\n            ]),\n            m(\"div.step-next\", [\n                m(\"span.hint\", gettext(\"and then...\")),\n                stepNextSelect\n            ])\n        ]);\n    });\n}\n\nfunction renderNewStepItemModal(ctrl, modalInfo) {\n    return m(\"div.new-step-item-modal-overlay\", {onclick: ctrl.closeNewStepItemModal}, [\n        m(\"div.new-step-item-modal\", [\n            m(\"div.title\", modalInfo.title),\n            m(\"div.item-options\", _.map(_.sortBy(_.values(infos[modalInfo.itemType]), \"name\"), function(item) {\n                return m(\"div.item-option\", {onclick: _.partial(ctrl.createNewStepItemFromModal, item.identifier)}, [\n                    m(\"div.item-name\", item.name),\n                    (item.description ? m(\"div.item-description\", item.description) : null)\n                ]);\n            }))\n        ])\n    ]);\n}\n\nfunction view(ctrl) {\n    var modal = null, modalInfo = null;\n    if ((modalInfo = ctrl.newStepItemModalInfo()) !== null) {\n        modal = renderNewStepItemModal(ctrl, modalInfo);\n    }\n    return m(\"div.step-list-wrapper\", [\n        m(\"div.steps\", [\n            stepTableRows(ctrl),\n            m(\"hr.script-separator\"),\n            m(\n                \"a.new-step-link.btn.btn-info.btn-sm\",\n                {href: \"#\", onclick: ctrl.addNewStep},\n                m(\"i.fa.fa-plus\"), \" \" + gettext(\"New step\")\n            )\n        ]),\n        modal\n    ]);\n}\n\nfunction generateItemOptions(nameMap) {\n    return _.sortBy(_.map(nameMap, function(name, value) {\n        return m(\"option\", {value: value}, name);\n    }), function(o) {\n        return o.children[0].toLowerCase();\n    });\n}\n\nfunction itemInfosToNameMap(itemInfos) {\n    return Object.assign({},\n        ...Object.keys(itemInfos).map((key) => ({\n            [itemInfos[key].identifier]: itemInfos[key].name\n        }))\n    );\n}\n\nfunction init(iSettings) {\n    settings = _.extend({}, iSettings);\n    infos.condition = settings.conditionInfos;\n    infos.action = settings.actionInfos;\n    names.condition = itemInfosToNameMap(infos.condition);\n    names.action = itemInfosToNameMap(infos.action);\n\n    optionLists.condOps = generateItemOptions(settings.condOps);\n    optionLists.stepNexts = generateItemOptions(settings.stepNexts);\n\n    controller = m.mount(document.getElementById(\"step-table-container\"), {\n        controller: Controller,\n        view: view\n    });\n    window.addEventListener(\"message\", function(event) {\n        if (event.data.new_data) {\n            controller.receiveItemEditData(event.data.new_data);\n        }\n    }, false);\n}\n\nfunction save() {\n    controller.saveState();\n}\n\nwindow.ScriptEditor = {\n    init,\n    save,\n    hideEditModal() {\n        if (controller) {\n            m.startComputation();\n            controller.setStepItemEditorState(false);\n            controller.activateStepItem(null);  // Deactivate the modal once data is received\n            m.endComputation();\n        }\n    }\n};\n","/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2021, Shuup Commerce Inc. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n // styles\nimport \"./script-editor.less\";\n\n// scripts\nimport \"./script-editor.js\";\n"]}